{
  "$schema": "http://json-schema.org/draft-07/schema#",
  "title": "Democracy Clock \u2013 Step 3 Trait Movement Table (v4.0)",
  "type": "object",
  "required": [
    "version",
    "week",
    "inputs",
    "policy",
    "categories",
    "rollups",
    "sanity_checks",
    "provenance"
  ],
  "properties": {
    "version": {
      "type": "string",
      "const": "4.0"
    },
    "week": {
      "type": "object",
      "required": [
        "number",
        "start",
        "end"
      ],
      "properties": {
        "number": {
          "type": "integer",
          "minimum": 1
        },
        "start": {
          "type": "string",
          "pattern": "^\\d{4}-\\d{2}-\\d{2}$"
        },
        "end": {
          "type": "string",
          "pattern": "^\\d{4}-\\d{2}-\\d{2}$"
        }
      },
      "additionalProperties": false
    },
    "inputs": {
      "type": "object",
      "required": [
        "carry_forward_baseline_week",
        "weekly_events_file"
      ],
      "properties": {
        "carry_forward_baseline_week": {
          "type": "integer",
          "minimum": 0
        },
        "weekly_events_file": {
          "type": "string"
        }
      },
      "additionalProperties": false
    },
    "policy": {
      "type": "object",
      "required": [
        "difficulty_rule",
        "include_zero_deltas",
        "clamp"
      ],
      "properties": {
        "difficulty_rule": {
          "type": "string",
          "enum": [
            "max"
          ]
        },
        "include_zero_deltas": {
          "type": "boolean"
        },
        "clamp": {
          "type": "object",
          "required": [
            "presence_min",
            "presence_max"
          ],
          "properties": {
            "presence_min": {
              "type": "number"
            },
            "presence_max": {
              "type": "number"
            }
          },
          "additionalProperties": false
        }
      },
      "additionalProperties": false
    },
    "categories": {
      "type": "array",
      "items": {
        "type": "object",
        "required": [
          "name",
          "index",
          "traits"
        ],
        "properties": {
          "name": {
            "type": "string"
          },
          "index": {
            "type": "integer",
            "minimum": 1
          },
          "traits": {
            "type": "array",
            "items": {
              "type": "object",
              "required": [
                "trait_id",
                "trait_number",
                "trait_name",
                "delta_presence",
                "difficulty_abs",
                "clamped",
                "justification",
                "mapping"
              ],
              "properties": {
                "trait_id": {
                  "type": "string"
                },
                "trait_number": {
                  "type": "integer",
                  "minimum": 1,
                  "maximum": 60
                },
                "trait_name": {
                  "type": "string"
                },
                "delta_presence": {
                  "type": "number"
                },
                "difficulty_abs": {
                  "type": "number"
                },
                "clamped": {
                  "type": "object",
                  "required": [
                    "presence",
                    "difficulty"
                  ],
                  "properties": {
                    "presence": {
                      "type": "boolean"
                    },
                    "difficulty": {
                      "type": "boolean"
                    }
                  },
                  "additionalProperties": false
                },
                "justification": {
                  "type": "object",
                  "required": [
                    "events_summary",
                    "impact_statement"
                  ],
                  "properties": {
                    "events_summary": {
                      "type": "string"
                    },
                    "impact_statement": {
                      "type": "string"
                    }
                  },
                  "additionalProperties": false
                },
                "links": {
                  "type": "object",
                  "properties": {
                    "event_ids": {
                      "type": "array",
                      "items": {
                        "type": "string"
                      }
                    },
                    "sources": {
                      "type": "array",
                      "items": {
                        "type": "string"
                      }
                    }
                  },
                  "additionalProperties": false
                },
                "mapping": {
                  "type": "object",
                  "required": [
                    "method"
                  ],
                  "properties": {
                    "method": {
                      "type": "string",
                      "enum": [
                        "rule",
                        "llm",
                        "manual",
                        "hybrid"
                      ]
                    },
                    "confidence": {
                      "type": "number",
                      "minimum": 0,
                      "maximum": 1
                    }
                  },
                  "additionalProperties": false
                }
              },
              "additionalProperties": false
            }
          }
        },
        "additionalProperties": false
      }
    },
    "rollups": {
      "type": "object",
      "required": [
        "totals",
        "by_category"
      ],
      "properties": {
        "totals": {
          "type": "object",
          "required": [
            "delta_presence_sum",
            "difficulty_abs_sum"
          ],
          "properties": {
            "delta_presence_sum": {
              "type": "number"
            },
            "difficulty_abs_sum": {
              "type": "number"
            }
          },
          "additionalProperties": false
        },
        "by_category": {
          "type": "array",
          "items": {
            "type": "object",
            "required": [
              "category",
              "delta_presence_sum",
              "traits_moved"
            ],
            "properties": {
              "category": {
                "type": "string"
              },
              "delta_presence_sum": {
                "type": "number"
              },
              "traits_moved": {
                "type": "integer",
                "minimum": 0
              }
            },
            "additionalProperties": false
          }
        }
      },
      "additionalProperties": false
    },
    "sanity_checks": {
      "type": "object",
      "required": [
        "event_density_ok",
        "category_coverage_ok",
        "suspicious_absences",
        "arithmetic_check"
      ],
      "properties": {
        "event_density_ok": {
          "type": "boolean"
        },
        "category_coverage_ok": {
          "type": "boolean"
        },
        "suspicious_absences": {
          "type": "array",
          "items": {
            "type": "string"
          }
        },
        "difficulty_calibration_note": {
          "type": "string"
        },
        "event_coverage_note": {
          "type": "string"
        },
        "arithmetic_check": {
          "type": "object",
          "required": [
            "delta_presence_sum",
            "difficulty_abs_sum"
          ],
          "properties": {
            "delta_presence_sum": {
              "type": "number"
            },
            "difficulty_abs_sum": {
              "type": "number"
            }
          },
          "additionalProperties": false
        },
        "cross_week_consistency_note": {
          "type": "string"
        }
      },
      "additionalProperties": false
    },
    "provenance": {
      "type": "object",
      "required": [
        "generated_at",
        "generator"
      ],
      "properties": {
        "generated_at": {
          "type": "string"
        },
        "generator": {
          "type": "string"
        },
        "hash": {
          "type": "string"
        }
      },
      "additionalProperties": false
    }
  },
  "additionalProperties": false
}